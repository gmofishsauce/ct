(function(){"use strict";let t=null,d="",a=1e3;const y=3e4;let u=!1;function n(e){postMessage({type:"debug",data:e})}function o(e){postMessage({type:"error",error:e,status:r(t)})}function r(e){return e?["connecting","ready","closing","down"][e.readyState]:"down"}async function l(){try{n("attempting connection");const e=await fetch(d+"/api/health");if(!e.ok){o("/api/health returned "+e.status),c();return}if(!(await e.json()).ok){o("/api/health response not ok"),c();return}n("health check OK");const p=d.replace(/^http/,"ws")+"/ws/run";t=new WebSocket(p),n("web socket created"),t.onopen=()=>{n("web socket opened"),u=!0,a=1e3,postMessage({type:"opened",status:r(t)})},t.onmessage=s=>{try{const g=JSON.parse(s.data),h=Object.assign({},g,{status:r(t)});postMessage(h)}catch{o("invalid JSON from server")}},t.onerror=s=>{o("WebSocket error: "+(s&&s.message?s.message:String(s))),u?postMessage({type:"fatal_disconnect",message:"Server connection error. You must refresh the page."}):c()},t.onclose=s=>{o("WebSocket closed: code "+(s.code||"unknown")+" reason "+(s.reason||"")),u?postMessage({type:"fatal_disconnect",message:"Server connection was lost. You must refresh the page."}):c()}}catch(e){o(e.message),c()}}function c(){n(`scheduling retry in ${a}ms`),setTimeout(l,a),a=Math.min(a*2,y)}onmessage=async e=>{const i=e.data;switch(i.type){case"open":n("open"),d=i.baseUrl||"",a=1e3,l();break;case"stdin":if(t&&t.readyState===WebSocket.OPEN){let p=JSON.stringify({type:"stdin",data:i.data});n("sending to server: "+p),t.send(p)}else postMessage({type:"error",error:"not connected",status:r(t)});break;default:postMessage({type:"error",error:"Unknown message type",status:r(t)});break}}})();
